// controllers/CollecteurController.js
const CollecteurService = require('../services/CollecteurService');
const { authenticate, authorizeRole } = require('../middlewares/auth');

class CollecteurController {

    // ====================
    // API
    // ====================

    static async getDemandesCollecte(req, res) {
        try {
            const demandes = await CollecteurService.getDemandesCollecte();
            res.status(200).json(demandes);
        } catch (err) {
            res.status(500).json({ message: err.message });
        }
    }

    static async accepterDemande(req, res) {
        try {
            const demande = await CollecteurService.accepterDemande(req.params.id);
            res.status(200).json(demande);
        } catch (err) {
            res.status(500).json({ message: err.message });
        }
    }

    static async rapporterCollecte(req, res) {
        try {
            const { description } = req.body;
            const rapport = await CollecteurService.rapporterCollecte(req.params.id, description);
            res.status(200).json(rapport);
        } catch (err) {
            res.status(500).json({ message: err.message });
        }
    }

    static async majStatutCollecte(req, res) {
        try {
            const updated = await CollecteurService.majStatutCollecte(req.params.id, req.body.statut);
            res.status(200).json(updated);
        } catch (err) {
            res.status(500).json({ message: err.message });
        }
    }

    static async getHistorique(req, res) {
        try {
            const historique = await CollecteurService.getHistorique(req.params.idCollecteur);
            res.status(200).json(historique);
        } catch (err) {
            res.status(500).json({ message: err.message });
        }
    }

    // ====================
    // Web Pages (EJS)
    // ====================

    static async pageDemandes(req, res) {
        try {
            const demandes = await CollecteurService.getDemandesCollecte();
            const collecteur = { nom: "Mohamed Ali", zone: "Borjlouzir" }; // temporaire
            res.render("Collecteur/demandes", { collecteur, demandes });
        } catch (err) {
            res.status(500).send("Erreur serveur : " + err.message);
        }
    }

    static async pageHistorique(req, res) {
        try {
            const collecteur = { nom: "Mohamed Ali", zone: "Borjlouzir" };
            const historique = await CollecteurService.getHistorique(req.params.idCollecteur);
            res.render("Collecteur/historique", { collecteur, historique });
        } catch (err) {
            res.status(500).send("Erreur serveur : " + err.message);
        }
    }

    static async accepterDemandeWeb(req, res) {
        try {
            await CollecteurService.accepterDemande(req.params.id);
            res.redirect('/collecteur/demandes');
        } catch (err) {
            res.status(500).send("Erreur serveur : " + err.message);
        }
    }

    static async rapporterCollecteWeb(req, res) {
        try {
            const { description } = req.body;
            await CollecteurService.rapporterCollecte(req.params.id, description);
            res.redirect('/collecteur/demandes');
        } catch (err) {
            res.status(500).send("Erreur serveur : " + err.message);
        }
    }

}

module.exports = CollecteurController;
