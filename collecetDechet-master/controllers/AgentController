const BaremeService = require('../services/BaremeService');
const CollecteurService = require('../services/CollecteurService');

class AgentController {

    // ============================
    // ðŸ”¹ API REST
    // ============================
    static async getBaremes(req, res) {
        try {
            const baremes = await BaremeService.getBaremes();
            res.status(200).json(baremes);
        } catch (err) {
            res.status(500).json({ message: err.message });
        }
    }

    static async addBareme(req, res) {
        try {
            await BaremeService.addBareme(req.body);
            res.redirect('/agent/dashboard'); // âœ… retour vers dashboard
        } catch (err) {
            res.status(500).send("Erreur ajout barÃ¨me : " + err.message);
        }
    }

    static async updateBareme(req, res) {
        try {
            await BaremeService.updateBareme(req.params.id, req.body);
            res.redirect('/agent/dashboard'); // âœ… retour vers dashboard
        } catch (err) {
            res.status(500).send("Erreur mise Ã  jour barÃ¨me : " + err.message);
        }
    }

    static async deleteBareme(req, res) {
        try {
            await BaremeService.deleteBareme(req.params.id);
            res.redirect('/agent/dashboard'); // âœ… retour vers dashboard
        } catch (err) {
            res.status(500).send("Erreur suppression barÃ¨me : " + err.message);
        }
    }

    static async getCollecteurs(req, res) {
        try {
            const collecteurs = await CollecteurService.getAllCollecteurs();
            res.status(200).json(collecteurs);
        } catch (err) {
            res.status(500).json({ message: err.message });
        }
    }

    static async addCollecteur(req, res) {
        try {
            await CollecteurService.addCollecteur(req.body);
            res.redirect('/agent/collecteurs'); // âœ… retour vers liste collecteurs
        } catch (err) {
            res.status(500).send("Erreur ajout collecteur : " + err.message);
        }
    }

    static async updateCollecteur(req, res) {
        try {
            await CollecteurService.updateCollecteur(req.params.id, req.body);
            res.redirect('/agent/collecteurs'); // âœ… retour vers liste collecteurs
        } catch (err) {
            res.status(500).send("Erreur mise Ã  jour collecteur : " + err.message);
        }
    }

    static async deleteCollecteur(req, res) {
        try {
            await CollecteurService.deleteCollecteur(req.params.id);
            res.redirect('/agent/collecteurs'); // âœ… retour vers liste collecteurs
        } catch (err) {
            res.status(500).send("Erreur suppression collecteur : " + err.message);
        }
    }

    // ============================
    // ðŸ”¹ Pages Web
    // ============================

    // === Dashboard (barÃ¨mes)
    static async pageDashboard(req, res) {
        try {
            const baremes = await BaremeService.getBaremes();
            const stats = {
                totalCollecteurs: 10,
                totalZones: 5,
                totalBaremes: baremes.length,
                collectesEffectuees: 20,
                collectesRapportees: 4
            };
            const agent = { nom: "hamza" };

            res.render("agent/dashboard", { baremes, stats, agent });
        } catch (err) {
            res.status(500).send("Erreur serveur : " + err.message);
        }
    }

    // === Liste collecteurs (avec ajout direct)
    static async pageCollecteurs(req, res) {
        try {
            const collecteurs = await CollecteurService.getAllCollecteurs();
            res.render("agent/collecteurs", { collecteurs });
        } catch (err) {
            res.status(500).send("Erreur serveur : " + err.message);
        }
    }
}

module.exports = AgentController;
